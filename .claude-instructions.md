# Claude Development Instructions

This file provides context and instructions for Claude Code when working on this project.

## Project Context

**Project:** The Invest Collective Website
**Tech Stack:** Next.js 15, Tailwind CSS v4, TypeScript, Cloudflare Workers (NOT Pages)
**Repository:** https://github.com/fstab50/invest-collective-site
**Primary Branch:** `develop`
**Deployment:** Cloudflare Workers via @opennextjs/cloudflare adapter

**CRITICAL: This is a Cloudflare Workers deployment, NOT Cloudflare Pages!**

- Use `@opennextjs/cloudflare` package (installed)
- Use `getCloudflareContext()` from `@opennextjs/cloudflare` to access env bindings
- DO NOT use `@cloudflare/next-on-pages` or `getRequestContext()`
- **DO NOT use `export const runtime = 'edge'` in pages or API routes!**
  - OpenNext Cloudflare automatically uses worker runtime for all routes
  - Adding `runtime = 'edge'` causes build failures
  - Worker runtime is implicit - no declaration needed

## Required Workflow: Issue-Driven Development

**CRITICAL: Always follow this workflow for features, enhancements, and bug fixes:**

### When to Create Issues

Create a GitHub issue for:

- ✅ New features (e.g., "Add user authentication")
- ✅ Enhancements to existing features (e.g., "Add topic filtering to research page")
- ✅ Bug fixes (e.g., "Fix page_path not being captured in analytics")
- ✅ Performance improvements (e.g., "Optimize hero image LCP score")
- ✅ Significant refactors (e.g., "Centralize page view tracking in layout")

Do NOT create issues for:

- ❌ Typo fixes in comments or documentation
- ❌ Code formatting changes
- ❌ Very minor CSS tweaks

### 1. Create GitHub Issue First
Before implementing any feature, enhancement, or fix, create a GitHub issue:

```bash
gh issue create --repo fstab50/invest-collective-site \
  --title "[Feature|Bug|Enhancement]: Brief description" \
  --body "## Description
[Detailed description]

## Tasks
- [ ] Task 1
- [ ] Task 2

## Priority
[Low|Medium|High]"
```

### 2. Implement the Solution
- Work in the `/Users/rmoore/Workspaces/InvestCollective/invest-collective-site` directory
- Test locally with `npm run dev`
- Follow existing code patterns

### 3. Commit with Issue Reference
**Always reference the issue number:**

```bash
git commit -m "Brief description

- Detailed change 1
- Detailed change 2

Fixes #N"
```

The `Fixes #N` keyword will automatically close the issue when pushed.

### 4. Close Issue (if not using Fixes #N)

If you didn't use `Fixes #N` in the commit, manually close the issue:

```bash
gh issue close N --repo fstab50/invest-collective-site -c "Implementation details:

✅ **Change 1** - Description
✅ **Change 2** - Description

Closed by commit HASH"
```

### 5. Push Changes
```bash
git push origin develop
```

---

## Key Commands

```bash
# GitHub CLI (ALWAYS use this repo flag)
gh issue create --repo fstab50/invest-collective-site ...
gh issue list --repo fstab50/invest-collective-site
gh issue view N --repo fstab50/invest-collective-site

# Development
npm run dev       # Local development server
npm run build     # Build Next.js
npm run deploy    # Deploy to Cloudflare

# Types
npm run cf-typegen  # Generate Cloudflare types
```

---

## Project-Specific Rules

### File Organization
- Components: `src/app/components/`
  - Layout: `src/app/components/layout/` (Navigation, Footer)
  - UI: `src/app/components/ui/` (shadcn/ui components)
- Pages: `src/app/[page-name]/page.tsx`
- Styles: `src/app/globals.css` imports theme files

### Styling Standards
- Use Tailwind CSS v4 (NOT v3)
- Tailwind v4 uses `@import` syntax in CSS files
- Mobile-first responsive design
- Use existing shadcn/ui components
- Brand color: `#2563eb` (blue-600)

### Git Standards
- Branch: `develop` (NOT main/master)
- Commit format: Descriptive title + bullet list + `Fixes #N`
- Always include Claude Code attribution in commits

### Cloudflare Workers Deployment

**IMPORTANT: This is NOT Cloudflare Pages - it's a Workers deployment!**

- Deployment: Cloudflare Workers (NOT Pages)
- **Auto-deploys:** Pushing to `develop` branch triggers automatic Cloudflare deployment
- **No manual deploy needed:** Git push = automatic production deployment
- `wrangler.jsonc` is gitignored (generated from template)
- `wrangler.jsonc.template` is the source of truth
- Build runs on Cloudflare's infrastructure after each push
- Check deployment status in Cloudflare dashboard or GitHub Actions

---

## Common Tasks

### Adding a New Page
1. Create issue: `gh issue create --repo fstab50/invest-collective-site --title "Feature: Add [page] page"`
2. Create `src/app/[page-name]/page.tsx`
3. Add to navigation in `src/app/components/layout/Navigation.tsx`
4. Test mobile responsiveness
5. Commit with `Fixes #N`

### Fixing a Bug
1. Create issue: `gh issue create --repo fstab50/invest-collective-site --title "Bug: [description]"`
2. Identify root cause
3. Implement fix
4. Test thoroughly
5. Commit with `Fixes #N`

### Adding a Component
1. Create issue if significant
2. Add to `src/app/components/ui/` (if UI component)
3. Use "use client" directive if needed
4. Follow shadcn/ui patterns
5. Export from component file

---

## Important Context

### Recent Changes

- **Research CMS implemented** - Full content management system with AI
  - Cloudflare R2 for PDF storage
  - Cloudflare D1 for article metadata
  - Cloudflare Workers AI for content extraction
  - Cloudflare Access authentication for admin routes
  - Admin upload form at `/admin/research/upload`
  - Public research pages at `/research` and `/research/[slug]`
- Contact form with Web3Forms integration
- Floating navigation with semi-transparent gradient background on scroll
- Mobile hamburger menu implemented
- Custom favicon with trending chart design
- Removed 73 unused packages (Material UI, Emotion, etc.)
- Fixed Cloudflare build issues with wrangler.jsonc gitignore

### Cloudflare Resources

- **R2 Bucket:** `invest-collective-research` (PDFs)
- **D1 Database:** `invest-collective-db` (ID: c5fff613-319c-4f52-a17e-0a9bccd6afbd)
- **Workers AI:** Enabled for content extraction
- **Schema:** See `schema.sql` in project root

### Authentication

- Cloudflare Access protects `/admin/*` routes
- Setup instructions in `CLOUDFLARE_ACCESS_SETUP.md`
- Middleware handles authentication checks
- Development mode bypasses auth automatically

### Known Issues

- None currently open

---

## Code Patterns to Follow

### Client Components
```typescript
'use client';

import Link from 'next/link';
import { Icon } from 'lucide-react';

export function Component() {
  // Component code
}
```

### Server Components (default)
```typescript
export default function Page() {
  // Server component
}
```

### Styling

```typescript
// Use Tailwind classes, responsive design
className="text-gray-700 hover:text-blue-600 transition-colors md:text-lg"
```

### Cloudflare Workers - Pages (Server Components)

```typescript
import { getCloudflareContext } from '@opennextjs/cloudflare';

// DO NOT add: export const runtime = 'edge'
// Worker runtime is automatic with OpenNext Cloudflare

export default async function Page() {
  // Access Cloudflare bindings
  const { env } = getCloudflareContext();
  const { DB, RESEARCH_PDFS, AI } = env;

  // Use D1 database
  const { results } = await DB.prepare('SELECT * FROM articles').all();

  return <div>{/* component */}</div>;
}
```

### Cloudflare Workers - Server Actions

```typescript
'use server';

import { getCloudflareContext } from '@opennextjs/cloudflare';

export async function myAction(formData: FormData) {
  const { env } = getCloudflareContext();
  const { DB, RESEARCH_PDFS, AI } = env;

  // Server action logic
  return { success: true };
}
```

### Cloudflare Workers - API Routes

```typescript
import { getCloudflareContext } from '@opennextjs/cloudflare';
import { NextRequest, NextResponse } from 'next/server';

// ❌ NEVER ADD: export const runtime = 'edge'
// ❌ This causes OpenNext build failures!
// ✅ Worker runtime is automatic with OpenNext Cloudflare

export async function GET(request: NextRequest) {
  const { env } = getCloudflareContext();
  const { DB } = env;

  // API logic
  return NextResponse.json({ data: [] });
}
```

#### CRITICAL: OpenNext Cloudflare Build Requirement

- **NEVER use `export const runtime = 'edge'`** in API routes or pages
- OpenNext requires edge runtime functions to be in separate function files
- All routes automatically use Worker runtime - no declaration needed
- Adding `runtime = 'edge'` will cause build error: "cannot use the edge runtime"

---

## What NOT to Do

❌ Don't commit without creating an issue first (for features/bugs)
❌ Don't push to main/master (use `develop`)
❌ Don't skip the `Fixes #N` in commit messages
❌ Don't use Tailwind v3 syntax (we're on v4)
❌ Don't commit `wrangler.jsonc` (it's gitignored)
❌ Don't create new files without testing locally first
❌ Don't add emojis unless explicitly requested
❌ **Don't use `@cloudflare/next-on-pages` or `getRequestContext()` - this is a Workers app!**
❌ **Don't use `export const runtime = 'edge'` in pages or API routes - causes build failures!**

---

## Session Handoff Notes

When starting a new session, Claude should:

1. ✅ Read this file for context
2. ✅ Check current git branch (`git branch`)
3. ✅ Review open issues (`gh issue list --repo fstab50/invest-collective-site`)
4. ✅ Ask user what they want to work on
5. ✅ Create issue before implementing
6. ✅ Reference issue in commits

---

**Last Updated:** January 5, 2026
**Claude Version:** Sonnet 4.5
